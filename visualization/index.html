<!doctype html>
<html>
    <head>
        <style>
            html, body {
                margin: 0;
                padding: 0;
            }
            #appContainer {
                position: relative;
                  width: 100vw;
                    height: 100vh;
                    overflow:hidden;
            }
            body {
                background: #000;
                color: #666;
            }
            .band-list-container {
                height: 100vh;
                overflow: scroll;
            }
            .band-list {
                font-size: 2em;
                opacity: 0;
                padding: 0;
                transition: 0.2s opacity;
                position: absolute;
                width: 100%;
            }
            .band-list.animate {
                transition: 2s transform, 0.2s opacity;
            }
            .band-list.out-to-left {
                transform: translateX(-100vw);
            }
            .band-list.out-to-right {
                transform: translateX(100vw);
            }
            .band-list.visible {
                opacity: 1;
            }
            .band-list li {
                transition: 0.5s color;
                list-style: none;
                margin: 1em 0 0;
                text-align: center;
                text-transform: uppercase;
            }
            .band-list li a {
                color: inherit;
                text-decoration: none;
                border-bottom: 4px #000 solid;
                transition: 1s border;
                //position: relative;
                //display: inline-block;
            }
            .band-list li a:focus {
                outline: none;
                border-bottom: 4px #966 solid;
            }

            .band-list li em {
                color: #999;
                font-style: normal;
                font-weight: bold;
            }

            .band-list .selected {
                color: #966;
            }

            .band-list li.selected em {
                color: #944;
            }
        </style>
    </head>
    <body>

        <div id="appContainer"></div>

        <script src="band-list.js"></script>
        <script src="./lib/event-emitter.js"></script>
        <script src="./audio/bad-song-composer.js"></script>

        <script>
        let currentBandList;
        let currentComposer;
        const appContainer = document.getElementById('appContainer');

        function showBandList(word, bands, index) {
          let previousBandList = currentBandList;

            if (previousBandList) {
              currentBandList = createBandList(word, bands);
              currentBandList.index = index;
              transition(previousBandList.el, currentBandList.el, previousBandList.index < currentBandList.index);
              //previousBandList.destroy();
            } else {
              currentBandList = createBandList(word, bands);
              currentBandList.index = index;
              appContainer.appendChild(currentBandList.el);
            }
            currentBandList.onMounted();

            if (currentComposer) {
              currentComposer.destroy();
            }
        }

        function transition (oldEl, newEl, direction) {
          newEl.classList.add(direction ? 'out-to-right' : 'out-to-left');
          appContainer.appendChild(newEl);
          window.requestAnimationFrame(() => {
            oldEl.classList.add(direction ? 'out-to-left' : 'out-to-right');
            newEl.classList.remove(direction ? 'out-to-right' : 'out-to-left');
          });
          //appContainer.removeChild(oldEl);
        }

        function createBandList(word, bands) {

            const bandList = new BandList(bands, word);
            currentBandList = bandList;

            let index = 0;

            const options = {

              vocals: {
                lang: 'en-', // prefix for matching Speech Synthesis voice languages
                pitch: 2, // highest possible pitch
                rate: 1,

                // Function that returns next lyric
                lyrics: (function () {
                    let index = -1;
                    return function () {
                      const words = bands.map((band) => band.name);
                      index += 1;
                      return words[index];
                    }
                }())
              },

              sample: {
                // Audio clip to repeat in between vocals. (We're making a very bad song here;
                //  vocals only occur during breaks in between all other music)
                src: 'audio/antagonist.mp3',

                // Duration to play audio clip for, in ms
                duration: 3400
              }
            };

            const composer = new BadSongComposer(options);

            currentComposer = composer;

            composer.on('vocalStart', () => {
              bandList.setIndex(index);
            });

            composer.on('vocalComplete', () => {
              bandList.clearHighlight();
              index++;
            });

            composer.play();

            return bandList;
        }

        window.fetch('ngrams.json')
          .then((data) => {
            return data.json();
          })
          .then((data) => {

            let index = 0;
            const word = data[index].word;
            const bands = data[index].bands;
  
            document.addEventListener('keyup', (e) => {
              switch (e.code) {
                case 'ArrowRight':
                  if (index < data.length - 2) {
                    index += 1;
                    showBandList(data[index].word, data[index].bands, index);
                  }
                  break;
                case 'ArrowLeft':
                  if (index > 0) {
                    index -= 1;
                    showBandList(data[index].word, data[index].bands, index);
                  }
                  break;
                case 'ArrowUp':
                case 'ArrowDown':
                  if (currentComposer) {
                    currentComposer.destroy();
                    currentComposer = null;
                  }
                  if (e.code === 'ArrowDown') {
                    currentBandList.next();
                  } else {
                    currentBandList.previous();
                  }
                  break;
              }
            });

            showBandList(word, bands);
          });

          </script>


        </body>
    </html>
